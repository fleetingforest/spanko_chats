<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Disciplinarian Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function showSection(id) {
            document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'history') loadHistory();
            if(id === 'rules') loadRules();
            if(id === 'punishments') loadPunishments();
            if(id === 'todo') loadTodos();
            if(id === 'chat') populateChatBoxWithHistory(); // Load chat history when chat section is shown
        }

        async function populateChatBoxWithHistory() {
            const chatBox = document.getElementById('chat-box');
            try {
                const res = await fetch('/data/history');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const history = await res.json();
                chatBox.value = ''; // Clear existing content
                history.forEach(h => {
                    if (h.role === 'user') {
                        chatBox.value += 'You: ' + h.content + '\n';
                    } else if (h.role === 'assistant') {
                        chatBox.value += 'AI: ' + h.content + '\n';
                    }
                    // System messages from history can be ignored for display in chat-box or handled if needed
                });
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
            } catch (error) {
                console.error("Failed to load chat history:", error);
                if (chatBox) { // Ensure chatBox exists before trying to set its value
                    chatBox.value += "\nError loading chat history.\n";
                }
            }
        }

        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim(); // Trim whitespace
            if(!message) return;

            const chatBox = document.getElementById('chat-box');
            
            // Display user's message immediately
            chatBox.value += '\nYou: ' + message + '\n';
            userInput.value = ''; // Clear input field
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll down

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });

                let data;
                if (!res.ok) {
                    // Try to parse error response, otherwise use status text
                    try {
                        data = await res.json();
                    } catch (e) {
                        data = { reply: `Error: ${res.statusText || 'Failed to send message'}` };
                    }
                    // Use error from JSON if available, otherwise the generic one
                    chatBox.value += 'AI: ' + (data.error || data.reply || `Failed to get response. Status: ${res.status}`) + '\n';
                } else {
                    data = await res.json();
                    chatBox.value += 'AI: ' + data.reply + '\n';
                }
            } catch (error) {
                console.error("SendMessage failed:", error);
                chatBox.value += 'AI: Sorry, an error occurred while sending your message.\n';
            }
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
        }

        async function loadHistory(){
            const res = await fetch('/data/history');
            const history = await res.json();
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            history.forEach(h => { if(h.role==='user'||h.role==='assistant'){ const li = document.createElement('li'); li.textContent = h.role+': '+h.content; list.appendChild(li);} });
        }
        async function loadRules(){
            const res = await fetch('/data/rules');
            const rules = await res.json();
            const list = document.getElementById('rules-list');
            list.innerHTML = '';
            rules.forEach(r => { const li = document.createElement('li'); li.textContent = r; list.appendChild(li); });
        }
        async function loadPunishments(){
            const res = await fetch('/data/punishments');
            const items = await res.json();
            const list = document.getElementById('punishments-list');
            list.innerHTML = '';
            items.forEach(p => { const li = document.createElement('li'); li.textContent = p.text + (p.completed ? ' (done)' : ''); list.appendChild(li); });
        }
        async function loadTodos(){
            const res = await fetch('/data/todos');
            const items = await res.json();
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            items.forEach(t => { const li = document.createElement('li'); li.textContent = t.text + (t.completed ? ' (done)' : ''); list.appendChild(li); });
        }

        // Initial load: show chat section and populate its history
        window.onload = function() {
            showSection('chat');
        };
    </script>
</head>
<body>
    <h1>Welcome, {{ session.user_name }}</h1>
    <nav>
        <button onclick="showSection('chat')">Chat</button>
        <button onclick="showSection('history')">History</button>
        <button onclick="showSection('rules')">Rules</button>
        <button onclick="showSection('punishments')">Punishments</button>
        <button onclick="showSection('todo')">To-Do</button>
    </nav>
    <div id="chat" class="section">
        {% include 'chat_section.html' %}
    </div>
    <div id="history" class="section" style="display:none">
        {% include 'history_section.html' %}
    </div>
    <div id="rules" class="section" style="display:none">
        {% include 'rules_section.html' %}
    </div>
    <div id="punishments" class="section" style="display:none">
        {% include 'punishments_section.html' %}
    </div>
    <div id="todo" class="section" style="display:none">
        {% include 'todo_section.html' %}
    </div>
</body>
</html>
