<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Disciplinarian Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function showSection(id) {
            document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'history') loadHistory();
            if(id === 'rules') loadRules();
            if(id === 'punishments') loadPunishments();
            if(id === 'todo') loadTodos();
        }

        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            if (!message) return;

            const chatBox = document.getElementById('chat-box');
            // Display user's message immediately
            chatBox.value += '\nYou: ' + message;
            // Scroll to bottom after adding user message
            chatBox.scrollTop = chatBox.scrollHeight; 
            
            userInput.value = ''; // Clear input field immediately

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });

                let aiResponseText = '';

                if (!res.ok) {
                    let errorMsg = `Error: ${res.status} ${res.statusText}`;
                    try {
                        const errorData = await res.json();
                        if (errorData && errorData.error) {
                            errorMsg = `Server error: ${errorData.error}`;
                        } else if (errorData && errorData.reply) { // Handle cases where error might be in 'reply'
                            errorMsg = `Server note: ${errorData.reply}`;
                        }
                    } catch (e) {
                        // Failed to parse error response as JSON, stick with status text
                        // Or the response was not JSON at all (e.g. HTML error page)
                        const rawErrorText = await res.text(); // Attempt to get raw text
                        errorMsg = `Error: ${res.status} ${res.statusText}. Response: ${rawErrorText.substring(0,100)}`;
                    }
                    aiResponseText = errorMsg;
                    console.error('Chat API error:', errorMsg);
                } else {
                    const data = await res.json();
                    if (data && data.reply) {
                        aiResponseText = data.reply;
                    } else {
                        aiResponseText = 'Received an empty or invalid response from server.';
                        console.error('Chat API response error: data or data.reply is missing', data);
                    }
                }
                chatBox.value += '\nAI: ' + aiResponseText;

            } catch (error) {
                chatBox.value += '\nAI: Failed to send message. Network error or server issue.';
                console.error('Failed to send message:', error);
            }
            // Scroll to bottom after AI response or error
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function loadHistory(){
            const res = await fetch('/data/history');
            const history = await res.json();
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            history.forEach(h => { if(h.role==='user'||h.role==='assistant'){ const li = document.createElement('li'); li.textContent = h.role+': '+h.content; list.appendChild(li);} });
        }
        async function loadRules(){
            const res = await fetch('/data/rules');
            const rules = await res.json();
            const list = document.getElementById('rules-list');
            list.innerHTML = '';
            rules.forEach(r => { const li = document.createElement('li'); li.textContent = r; list.appendChild(li); });
        }
        async function loadPunishments(){
            const res = await fetch('/data/punishments');
            const items = await res.json();
            const list = document.getElementById('punishments-list');
            list.innerHTML = '';
            items.forEach(p => { const li = document.createElement('li'); li.textContent = p.text + (p.completed ? ' (done)' : ''); list.appendChild(li); });
        }
        async function loadTodos(){
            const res = await fetch('/data/todos');
            const items = await res.json();
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            items.forEach(t => { const li = document.createElement('li'); li.textContent = t.text + (t.completed ? ' (done)' : ''); list.appendChild(li); });
        }
    </script>
</head>
<body>
    <h1>Welcome, {{ session.user_name }}</h1>
    <nav>
        <button onclick="showSection('chat')">Chat</button>
        <button onclick="showSection('history')">History</button>
        <button onclick="showSection('rules')">Rules</button>
        <button onclick="showSection('punishments')">Punishments</button>
        <button onclick="showSection('todo')">To-Do</button>
    </nav>
    <div id="chat" class="section">
        {% include 'chat_section.html' %}
    </div>
    <div id="history" class="section" style="display:none">
        {% include 'history_section.html' %}
    </div>
    <div id="rules" class="section" style="display:none">
        {% include 'rules_section.html' %}
    </div>
    <div id="punishments" class="section" style="display:none">
        {% include 'punishments_section.html' %}
    </div>
    <div id="todo" class="section" style="display:none">
        {% include 'todo_section.html' %}
    </div>
</body>
</html>
